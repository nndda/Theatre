name: Dialogue Test

on:
  push:
    branches:
      - main
      - dev
    paths:
      - '.github/workflows/dialogue-test.yml'
      - 'addons/Theatre/classes/Dialogue.gd'
      - 'addons/Theatre/classes/DialogueParser.gd'
      - 'dialogue/**.dlg'
      - 'dialogue/**.REF.tres'
      - 'tests/class/**'
      - 'tests/**_ci.gd'
  pull_request:
    branches:
      - main
    paths:
      - '.github/workflows/dialogue-test.yml'
      - 'addons/Theatre/classes/Dialogue.gd'
      - 'addons/Theatre/classes/DialogueParser.gd'
      - 'dialogue/**.dlg'
      - 'dialogue/**.REF.tres'
      - 'tests/class/**'
      - 'tests/**_ci.gd'
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  test:
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
        godot-version: 
          - 4.4
          - 4.5

    runs-on: ${{ matrix.os }}

    env:
      GODOT_VERSION: ${{ matrix.godot-version }}-stable

    steps:
      - uses: actions/checkout@v5

      - name: Set Godot binary for Linux
        if: ${{ matrix.os == 'ubuntu-latest' }}
        run: echo "GODOT_BINARY=Godot_v${{ matrix.godot-version }}-stable_linux.x86_64" >> $GITHUB_ENV

      - name: Set Godot binary for Windows
        if: ${{ matrix.os == 'windows-latest' }}
        run: echo "GODOT_BINARY=Godot_v${{ matrix.godot-version }}-stable_win64.exe" >> $GITHUB_ENV

      - name: Cache Godot binary
        id: godotbin-cache
        uses: actions/cache@v4
        with:
          path: ./${{ env.GODOT_BINARY }}
          key: ${{ env.GODOT_BINARY }}

      - name: Download Godot if not cached
        if: steps.godotbin-cache.outputs.cache-hit != 'true'
        run: |
          curl -L -o ${{ env.GODOT_BINARY }}.zip https://github.com/godotengine/godot/releases/download/${{ env.GODOT_VERSION }}/${{ env.GODOT_BINARY }}.zip
          unzip -o ./${{ env.GODOT_BINARY }}.zip

      - name: Import project assets
        run |
          ./${{ env.GODOT_BINARY }} \
            --headless \
            --import

      - name: Run parser test
        run: |
          ./${{ env.GODOT_BINARY }} \
            --no-header \
            --headless \
            --script ./tests/dialogue_test_ci.gd

      - name: Run parser benchmark test
        run: |
          ./${{ env.GODOT_BINARY }} \
            --no-header \
            --headless \
            --script ./tests/benchmark_ci.gd
